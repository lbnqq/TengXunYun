# 补充后端接口设计

基于前端设计和现有后端API的全面分析，我确定了几个缺失的功能。以下是针对这些差距的API设计建议，这些建议与`web_app.py`文件的现有结构保持一致，遵循RESTful API设计的最佳实践。

## 1. 文风统一预览与接受/拒绝
**目的**：允许用户预览应用于文档的文风变化，并逐个或批量接受或拒绝这些变化。

**建议的API端点**：
- **预览文风变化**
  - **端点**：`/api/style-alignment/preview`
  - **方法**：`POST`
  - **参数**：
    - `document_content` (string)：要应用文风变化的文档内容。
    - `document_name` (string)：文档名称。
    - `style_template_id` (string)：要应用的文风模板ID。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `preview_data` (object)：包含带有高亮变化和建议的原始内容。
      - `original_content` (string)：原始文档内容。
      - `suggested_changes` (array)：包含ID、原始文本、建议文本和简要修改原因（如"增强正式性"）的变化列表。
    - `session_id` (string)：用于后续操作的预览会话的唯一标识符。
  - **描述**：此端点使用所选文风模板处理文档，并返回变化预览，突出显示差异并简要说明每个修改的原因，而不永久应用它们。

- **接受/拒绝单个变化**
  - **端点**：`/api/style-alignment/changes/<session_id>/<change_id>`
  - **方法**：`PATCH`
  - **参数**：
    - `action` (string)：指示对特定变化的操作，值为"accept"或"reject"。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `change_id` (string)：被操作的变化ID。
    - `action` (string)：执行的操作（"accept"或"reject"）。
    - `updated_preview` (object)：可选地返回操作后的更新预览。
  - **描述**：允许用户接受或拒绝预览中识别的特定变化。

- **接受/拒绝所有变化**
  - **端点**：`/api/style-alignment/changes/<session_id>/batch`
  - **方法**：`PATCH`
  - **参数**：
    - `action` (string)：对所有变化应用的操作，值为"accept_all"或"reject_all"。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `action` (string)：执行的批量操作。
    - `change_count` (integer)：受操作影响的变化数量。
  - **描述**：允许用户一次性接受或拒绝预览会话中的所有变化。

- **导出文风调整后的文档**
  - **端点**：`/api/style-alignment/export/<session_id>`
  - **方法**：`GET`
  - **参数**：无
  - **响应**：返回应用了所有接受的文风变化的文档作为可下载的DOCX文件，并提供HTML版本用于预览或下载。
    - 头信息：`Content-Disposition: attachment; filename=styled_document.docx`
    - 可选：`Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document`用于DOCX，或`text/html; charset=utf-8`用于HTML预览。
  - **描述**：导出应用了所有接受的文风变化的文档，以DOCX格式提供，同时提供HTML版本用于显示或下载。

## 2. 智能填报的自动匹配数据
**目的**：在填报过程中启用数据到文档模板字段的自动匹配。

**建议的API端点**：
- **自动匹配数据**
  - **端点**：`/api/document-fill/auto-match`
  - **方法**：`POST`
  - **参数**：
    - `session_id` (string)：活动文档填报会话的ID。
    - `data_sources` (array)：要与文档字段匹配的数据源列表（文本或文件引用）。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `matched_fields` (object)：包含字段ID映射到匹配数据值的对象。
    - `unmatched_fields` (array)：无法自动匹配的字段ID列表。
    - `confidence_scores` (object)：每个匹配字段的置信度分数（例如，{"field1": 0.95, "field2": 0.75}）。
    - `conflicts` (array)：多个数据源为同一字段提供值时的冲突列表，每个冲突包含：
      - `field_id` (string)：冲突字段的ID。
      - `options` (array)：来自不同源的可能值列表，每个值包含源名称和置信度分数。
  - **描述**：分析提供的数据源，并基于字段名称、上下文或AI推断自动将数据匹配到文档模板中的字段。如果出现冲突（同一字段有多个值），则汇总供用户确认，并提供置信度分数作为参考。

- **解决冲突**
  - **端点**：`/api/document-fill/auto-match/conflicts/<session_id>`
  - **方法**：`PATCH`
  - **参数**：
    - `resolutions` (object)：用户解决冲突的选择，将字段ID映射到所选值（例如，{"field1": "value_from_source1"}）。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `resolved_fields` (object)：解决冲突的字段及其最终值。
  - **描述**：允许用户通过为每个冲突字段选择首选值来解决冲突，基于汇总的选项和置信度分数。

## 3. 文档审阅
**目的**：支持完整的文档审阅过程，包括发起审阅、获取建议、接受/拒绝建议以及导出审阅后的文档。

**建议的API端点**：
- **开始审阅**
  - **端点**：`/api/document-review/start`
  - **方法**：`POST`
  - **参数**：
    - `document_content` (string)：要审阅的文档内容。
    - `document_name` (string)：文档名称。
    - `review_focus` (string)：审阅的重点（例如，"academic"、"business"、"auto"）。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `review_session_id` (string)：审阅会话的唯一标识符。
    - `status` (string)：审阅过程的初始状态（例如，"in_progress"）。
  - **描述**：为提供的文档发起具有指定重点的审阅过程。审阅过程使用LLM的提示，例如："请以你的专业角度，给与最严苛最严厉的评审意见，按问题优先级指出问题列表，最后给出修改建议！" 审阅首先关注内容（相关性、准确性、深度），其次是结构、风格和语法。

- **获取审阅建议**
  - **端点**：`/api/document-review/suggestions/<review_session_id>`
  - **方法**：`GET`
  - **参数**：无
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `suggestions` (array)：按优先级排序的审阅建议列表（内容 > 结构 > 风格 > 语法），每个建议包含：
      - `suggestion_id` (string)：建议的唯一标识符。
      - `original_text` (string)：原始文本段。
      - `suggested_text` (string)：建议的替换或评论。
      - `reason` (string)：建议的原因，反映专业批评。
      - `type` (string)：建议类型（例如，"content"、"structure"、"style"、"grammar"）。
      - `status` (string)：当前状态（"pending"、"accepted"、"rejected"）。
      - `priority` (integer)：基于问题类型的优先级（内容为1，结构为2等）。
  - **描述**：获取指定会话在审阅过程中生成的所有建议，首先关注内容问题，其次是结构、风格和语法，从专业角度进行评估。

- **接受/拒绝建议**
  - **端点**：`/api/document-review/suggestions/<review_session_id>/<suggestion_id>`
  - **方法**：`PATCH`
  - **参数**：
    - `action` (string)：指示对特定建议的操作，值为"accept"或"reject"。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `suggestion_id` (string)：被操作的建议ID。
    - `action` (string)：执行的操作（"accept"或"reject"）。
  - **描述**：允许用户接受或拒绝特定建议。

- **接受/拒绝所有建议**
  - **端点**：`/api/document-review/suggestions/<review_session_id>/batch`
  - **方法**：`PATCH`
  - **参数**：
    - `action` (string)：对所有建议应用的操作，值为"accept_all"或"reject_all"。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `action` (string)：执行的批量操作。
    - `suggestion_count` (integer)：受操作影响的建议数量。
  - **描述**：允许用户一次性接受或拒绝审阅会话中的所有建议。

- **导出审阅后的文档**
  - **端点**：`/api/document-review/export/<review_session_id>`
  - **方法**：`GET`
  - **参数**：无
  - **响应**：返回应用了接受的建议的审阅文档作为可下载的DOCX文件，并提供HTML版本用于预览。
    - 头信息：`Content-Disposition: attachment; filename=reviewed_document.docx`
  - **描述**：导出应用了所有接受的审阅建议的文档，以DOCX格式提供，并提供HTML版本用于显示或下载。

## 4. 模板管理（格式和文风）
**目的**：实现格式和文风模板的全面管理，包括重命名和删除。

**建议的API端点**：
- **重命名模板**
  - **端点**：`/api/templates/<template_type>/<template_id>/rename`
  - **方法**：`PATCH`
  - **参数**：
    - `template_type` (string)：指定模板类型，值为"format"或"style"。
    - `new_name` (string)：模板的新名称。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `template_id` (string)：重命名的模板ID。
    - `new_name` (string)：模板更新后的名称。
  - **描述**：重命名现有的格式或文风模板。

- **删除模板确认**
  - **端点**：`/api/templates/<template_type>/<template_id>/confirm-delete`
  - **方法**：`GET`
  - **参数**：
    - `template_type` (string)：指定模板类型，值为"format"或"style"。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `confirmation_message` (string)：提醒用户删除后果的消息（例如，"您确定要删除此模板吗？此操作无法撤销。"）。
    - `confirmation_token` (string)：完成删除所需的临时令牌。
  - **描述**：在删除前提供确认步骤，提醒用户操作的永久性，并要求令牌用于最终删除步骤。

- **确认删除模板**
  - **端点**：`/api/templates/<template_type>/<template_id>`
  - **方法**：`DELETE`
  - **参数**：
    - `template_type` (string)：指定模板类型，值为"format"或"style"。
    - `confirmation_token` (string)：从确认步骤收到的令牌，用于验证删除。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `template_id` (string)：删除的模板ID。
  - **描述**：在用户使用提供的令牌确认后，删除现有的格式或文风模板。

## 5. 从历史记录中重新应用操作
**目的**：允许用户从文档处理历史记录中重新应用特定操作。

**建议的API端点**：
- **重新应用操作**
  - **端点**：`/api/documents/history/<record_id>/reapply`
  - **方法**：`POST`
  - **参数**：
    - `record_id` (string)：要重新应用的历史记录ID。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `new_record_id` (string)：通过重新应用操作创建的新处理记录ID。
    - `status` (string)：重新应用过程的状态（例如，"in_progress"、"completed"、"file_missing"）。
    - `message` (string, 可选)：如果原始文件缺失，则显示类似"原始文件不再可用。请重新上传文件以继续。"的消息。
  - **描述**：使用相同的参数和文件（如果可用）重新应用指定历史记录中的处理操作。如果原始文件缺失，则通知用户重新上传文件并不继续操作。

- **为重新应用上传文件**
  - **端点**：`/api/documents/history/<record_id>/upload`
  - **方法**：`POST`
  - **参数**：
    - `record_id` (string)：要为其上传文件的历史记录ID。
    - `file` (file)：作为缺失原始文件替代品上传的文件。
  - **响应**：
    - `success` (boolean)：指示操作是否成功。
    - `file_path` (string)：上传文件的路径。
    - `message` (string)：确认消息（例如，"文件上传成功。您现在可以重新应用操作。"）。
  - **描述**：允许用户为原始文件缺失的历史操作上传替代文件，使重新应用过程能够继续。

# 结论
这些API设计建议填补了前端设计与当前后端能力之间的差距。它们遵循`web_app.py`文件中使用的RESTful约定，与项目的架构保持一致。实施这些端点将全面支持前端HTML中设想的功能，解决后端API中识别的所有差距。
