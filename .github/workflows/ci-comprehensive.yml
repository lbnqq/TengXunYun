name: Comprehensive CI Integration Tests

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•
    - cron: '0 2 * * *'

jobs:
  # çŽ¯å¢ƒå‡†å¤‡å’Œä¾èµ–å®‰è£…
  setup:
    runs-on: ubuntu-latest
    outputs:
      python-version: ${{ steps.setup-python.outputs.python-version }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        id: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-cov pytest-mock pytest-asyncio pytest-html pytest-xdist pytest-timeout pytest-benchmark
          pip install coverage flake8 mypy black isort bandit safety

  # CLIä¸šåŠ¡åœºæ™¯è´¯é€šæ€§æµ‹è¯• (P1: å¼ºåˆ¶æ£€æŸ¥)
  cli-business-scenarios:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Create test data directories
        run: |
          mkdir -p cliTests/test_data
          mkdir -p cliTests/test_results
      - name: Run CLI business scenario tests
        run: |
          echo "ðŸš€ å¼€å§‹æ‰§è¡ŒCLIä¸šåŠ¡åœºæ™¯è´¯é€šæ€§æµ‹è¯•..."
          python cliTests/run_all_tests.py --report --verbose
      - name: Check CLI test results
        run: |
          if [ ! -f "cliTests/test_results/batch_test_report.json" ]; then
            echo "âŒ CLIæµ‹è¯•æŠ¥å‘Šæœªç”Ÿæˆï¼Œæµ‹è¯•å¤±è´¥ï¼"
            exit 1
          fi
          
          # æ£€æŸ¥æµ‹è¯•ç»“æžœ
          python -c "
          import json
          with open('cliTests/test_results/batch_test_report.json', 'r', encoding='utf-8') as f:
              report = json.load(f)
          
          failed_tests = [test for test in report['tests'] if not test['success']]
          if failed_tests:
              print(f'âŒ CLIä¸šåŠ¡åœºæ™¯æµ‹è¯•å¤±è´¥: {len(failed_tests)}ä¸ªæµ‹è¯•æœªé€šè¿‡')
              for test in failed_tests:
                  print(f'  - {test[\"name\"]}: {test[\"error\"]}')
              exit(1)
          else:
              print('âœ… æ‰€æœ‰CLIä¸šåŠ¡åœºæ™¯æµ‹è¯•é€šè¿‡')
          "
      - name: Upload CLI test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cli-test-results
          path: |
            cliTests/test_results/
            cliTests/test_data/

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 mypy black isort bandit safety
      - name: Check code formatting with black
        run: |
          black --check --diff src/ tests/
      - name: Check import sorting with isort
        run: |
          isort --check-only --diff src/ tests/
      - name: Lint with flake8
        run: |
          flake8 src/ tests/ --max-line-length=120 --ignore=E203,W503
      - name: Type check with mypy
        run: |
          mypy src/ --ignore-missing-imports --no-strict-optional
      - name: Security check with bandit
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
      - name: Check for known security vulnerabilities
        run: |
          safety check --json --output safety-report.json || true

  # å•å…ƒæµ‹è¯•
  unit-tests:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10']
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run unit tests with coverage
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=html --cov-report=term-missing
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # é›†æˆæµ‹è¯•
  integration-tests:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run integration tests
        run: |
          pytest tests/test_integration.py tests/test_comprehensive_integration.py -v --timeout=300
      - name: Run E2E tests
        run: |
          pytest tests/test_e2e_complete_system.py tests/test_e2e_workflow.py -v --timeout=600

  # APIæµ‹è¯•
  api-tests:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Start web server
        run: |
          python src/web_app.py &
          sleep 10
      - name: Run API tests
        run: |
          pytest tests/test_api_comprehensive.py tests/test_api_content_type.py -v --timeout=300

  # MVPåŠŸèƒ½æµ‹è¯•
  mvp-tests:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run MVP functionality tests
        run: |
          python tests/test_mvp_functionality.py

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run performance tests
        run: |
          pytest tests/test_e2e_performance.py -v --benchmark-only

  # å››ä½ä¸€ä½“è‡ªåŠ¨åŒ–æ ¡éªŒ (P1: å¼ºåˆ¶æ£€æŸ¥)
  four-in-one-validation:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Compare API usage with doc
        run: |
          python tools/compare_api_usage_with_doc.py
      - name: Compare id usage with report
        run: |
          python tools/compare_id_usage_with_report.py
      - name: Check API structure consistency
        run: |
          python tools/project_status_checker.py --check-api-structure
      - name: Check frontend API usage consistency
        run: |
          python tools/project_status_checker.py --check-frontend-api-usage
      - name: Fail if API diff found
        run: |
          if grep -q 'å»ºè®®:' api_usage_diff_report.md; then 
            echo 'âŒ APIå®žçŽ°ä¸Žæ–‡æ¡£ä¸ä¸€è‡´ï¼Œç¦æ­¢åˆå¹¶ï¼'
            echo 'è¯·æ£€æŸ¥å¹¶ä¿®å¤ä»¥ä¸‹é—®é¢˜:'
            cat api_usage_diff_report.md
            exit 1
          fi
      - name: Fail if id diff found
        run: |
          if grep -q 'å»ºè®®:' id_usage_diff_report.md; then 
            echo 'âŒ é¡µé¢å…ƒç´ idå®žçŽ°ä¸Žå¯¹ç…§è¡¨ä¸ä¸€è‡´ï¼Œç¦æ­¢åˆå¹¶ï¼'
            echo 'è¯·æ£€æŸ¥å¹¶ä¿®å¤ä»¥ä¸‹é—®é¢˜:'
            cat id_usage_diff_report.md
            exit 1
          fi

  # é¡¹ç›®å®ªæ³•åˆè§„æ€§æ£€æŸ¥ (P1: å¼ºåˆ¶æ£€æŸ¥)
  constitution-compliance:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Check project constitution compliance
        run: |
          echo "ðŸ” æ£€æŸ¥é¡¹ç›®å®ªæ³•åˆè§„æ€§..."
          
          # æ£€æŸ¥AIç”Ÿæˆä»£ç æ ‡è®°
          echo "æ£€æŸ¥AIç”Ÿæˆä»£ç æ ‡è®°..."
          if grep -r "AI-Generated" src/ --include="*.py" | grep -v "@AI-Generated"; then
            echo "âŒ å‘çŽ°æœªæ ‡è®°çš„AIç”Ÿæˆä»£ç ï¼Œè¯·æ·»åŠ @AI-Generatedæ ‡è®°"
            exit 1
          fi
          
          # æ£€æŸ¥docstringå®Œæ•´æ€§
          echo "æ£€æŸ¥docstringå®Œæ•´æ€§..."
          python tools/check_file_headers.py
          
          # æ£€æŸ¥é«˜é¢‘æ˜“é”™ç‚¹é˜²æŽ§æŠ¥å‘Š
          echo "æ£€æŸ¥é«˜é¢‘æ˜“é”™ç‚¹é˜²æŽ§æŠ¥å‘Š..."
          if [ ! -f "docs/é«˜é¢‘æ˜“é”™ç‚¹é˜²æŽ§ä¸Žæ‰«ææŠ¥å‘Š.md" ]; then
            echo "âŒ é«˜é¢‘æ˜“é”™ç‚¹é˜²æŽ§æŠ¥å‘Šç¼ºå¤±"
            exit 1
          fi
          
          echo "âœ… é¡¹ç›®å®ªæ³•åˆè§„æ€§æ£€æŸ¥é€šè¿‡"

  # å®šæœŸå¤ç›˜å’ŒæŒç»­æ”¹è¿› (P2: å®šæœŸæ‰§è¡Œ)
  periodic-analysis:
    needs: setup
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run CLI test analysis
        run: |
          echo "ðŸ” å¼€å§‹CLIæµ‹è¯•å®šæœŸå¤ç›˜åˆ†æž..."
          python tools/cli_test_analyzer.py --days 30 --html
      - name: Upload analysis reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cli-test-analysis-reports
          path: |
            cliTests/test_results/cli_test_analysis_report_*.json
            cliTests/test_results/cli_test_analysis_report_*.html
      - name: Generate improvement summary
        run: |
          echo "ðŸ“‹ ç”Ÿæˆæ”¹è¿›å»ºè®®æ‘˜è¦..."
          python -c "
          import json
          import glob
          from pathlib import Path
          
          # æŸ¥æ‰¾æœ€æ–°çš„åˆ†æžæŠ¥å‘Š
          analysis_files = glob.glob('cliTests/test_results/cli_test_analysis_report_*.json')
          if not analysis_files:
              print('âŒ æœªæ‰¾åˆ°åˆ†æžæŠ¥å‘Šæ–‡ä»¶')
              exit(0)
          
          latest_file = max(analysis_files, key=lambda x: Path(x).stat().st_mtime)
          
          with open(latest_file, 'r', encoding='utf-8') as f:
              analysis = json.load(f)
          
          print('ðŸŽ¯ CLIæµ‹è¯•å®šæœŸå¤ç›˜åˆ†æžç»“æžœ:')
          print('=' * 50)
          
          # æµ‹è¯•è¦†ç›–çŽ‡
          coverage = analysis.get('test_coverage', {})
          print(f'ðŸ“Š åˆ†æžæŠ¥å‘Šæ•°: {coverage.get(\"total_runs\", 0)}')
          
          # å¤±è´¥æ¨¡å¼
          failures = analysis.get('failure_patterns', {})
          failing_tests = failures.get('failing_tests', {})
          if failing_tests:
              most_failing = max(failing_tests.items(), key=lambda x: x[1])
              print(f'ðŸ” æœ€é¢‘ç¹å¤±è´¥æµ‹è¯•: {most_failing[0]} (å¤±è´¥{most_failing[1]}æ¬¡)')
          
          # æ€§èƒ½é—®é¢˜
          performance = analysis.get('performance_issues', {})
          slow_tests = performance.get('slow_tests', [])
          if slow_tests:
              print(f'âš¡ å‘çŽ° {len(slow_tests)} ä¸ªæ…¢é€Ÿæµ‹è¯•')
          
          # é—æ¼åœºæ™¯
          missing = analysis.get('missing_scenarios', {})
          total_missing = sum(len(scenarios) for scenarios in missing.values())
          if total_missing > 0:
              print(f'ðŸŽ¯ å‘çŽ° {total_missing} ä¸ªé—æ¼çš„æµ‹è¯•åœºæ™¯')
          
          # æ”¹è¿›å»ºè®®
          recommendations = analysis.get('recommendations', [])
          print(f'ðŸ’¡ æ”¹è¿›å»ºè®®æ•°é‡: {len(recommendations)}')
          
          print('\\nðŸ“‹ ä¼˜å…ˆçº§æ”¹è¿›ä»»åŠ¡:')
          plan = analysis.get('improvement_plan', {})
          priority_tasks = plan.get('priority_tasks', [])
          for i, task in enumerate(priority_tasks, 1):
              print(f'  {i}. {task}')
          
          print('\\nâœ… å®šæœŸå¤ç›˜åˆ†æžå®Œæˆï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š')
          "

  # æœ€ç»ˆåˆå¹¶æ£€æŸ¥
  merge-gate:
    needs: [cli-business-scenarios, code-quality, unit-tests, integration-tests, api-tests, four-in-one-validation, constitution-compliance]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Check all tests passed
        run: |
          echo "ðŸŽ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸åˆå¹¶ï¼"
          echo "âœ… CLIä¸šåŠ¡åœºæ™¯æµ‹è¯•é€šè¿‡"
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
          echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
          echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"
          echo "âœ… APIæµ‹è¯•é€šè¿‡"
          echo "âœ… å››ä½ä¸€ä½“è‡ªåŠ¨åŒ–æ ¡éªŒé€šè¿‡"
          echo "âœ… é¡¹ç›®å®ªæ³•åˆè§„æ€§æ£€æŸ¥é€šè¿‡"
      - name: Generate merge report
        run: |
          echo "## ðŸš€ åˆå¹¶æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… é€šè¿‡çš„æ£€æŸ¥é¡¹" >> $GITHUB_STEP_SUMMARY
          echo "- CLIä¸šåŠ¡åœºæ™¯è´¯é€šæ€§æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- ä»£ç è´¨é‡æ£€æŸ¥ (flake8, mypy, black, isort)" >> $GITHUB_STEP_SUMMARY
          echo "- å•å…ƒæµ‹è¯• (è¦†ç›–çŽ‡æ£€æŸ¥)" >> $GITHUB_STEP_SUMMARY
          echo "- é›†æˆæµ‹è¯• (APIé›†æˆ)" >> $GITHUB_STEP_SUMMARY
          echo "- APIæµ‹è¯• (æŽ¥å£åŠŸèƒ½)" >> $GITHUB_STEP_SUMMARY
          echo "- å››ä½ä¸€ä½“è‡ªåŠ¨åŒ–æ ¡éªŒ (æŽ¥å£ã€é¡µé¢ã€AIä»£ç ã€æµ‹è¯•è„šæœ¬ä¸€è‡´æ€§)" >> $GITHUB_STEP_SUMMARY
          echo "- é¡¹ç›®å®ªæ³•åˆè§„æ€§æ£€æŸ¥ (AIæ ‡è®°ã€docstringã€è§„èŒƒ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š æµ‹è¯•ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- æ€»æ£€æŸ¥é¡¹: 7é¡¹" >> $GITHUB_STEP_SUMMARY
          echo "- é€šè¿‡é¡¹: 7é¡¹" >> $GITHUB_STEP_SUMMARY
          echo "- å¤±è´¥é¡¹: 0é¡¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **åŸºäºŽé¡¹ç›®å®ªæ³•çš„å·¥ç¨‹å¯ç”¨æ€§ä¿éšœæœºåˆ¶å·²ç”Ÿæ•ˆ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ æŒç»­æ”¹è¿›æœºåˆ¶" >> $GITHUB_STEP_SUMMARY
          echo "- å®šæœŸå¤ç›˜: æ¯æœˆè‡ªåŠ¨åˆ†æžCLIæµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- å¤±è´¥åˆ†æž: è‡ªåŠ¨è¯†åˆ«å¤±è´¥æ¨¡å¼å’Œæ ¹æœ¬åŽŸå› " >> $GITHUB_STEP_SUMMARY
          echo "- æ€§èƒ½ç›‘æŽ§: æŒç»­è·Ÿè¸ªæµ‹è¯•æ‰§è¡Œæ€§èƒ½" >> $GITHUB_STEP_SUMMARY
          echo "- åœºæ™¯è¡¥å……: è‡ªåŠ¨è¯†åˆ«é—æ¼çš„æµ‹è¯•åœºæ™¯" >> $GITHUB_STEP_SUMMARY
          echo "- æ”¹è¿›å»ºè®®: åŸºäºŽåˆ†æžç»“æžœç”Ÿæˆå…·ä½“æ”¹è¿›è®¡åˆ’" >> $GITHUB_STEP_SUMMARY 