name: Method Implementation Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # 每天凌晨2点运行
    - cron: '0 2 * * *'

jobs:
  method-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run method implementation check
      run: |
        python tools/method_implementation_checker.py
        
    - name: Upload check report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: method-implementation-report
        path: docs/reports/method_implementation_report_*.json
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // 查找最新的报告文件
          const reportsDir = 'docs/reports';
          const reportFiles = fs.readdirSync(reportsDir)
            .filter(file => file.startsWith('method_implementation_report_'))
            .sort()
            .reverse();
          
          if (reportFiles.length > 0) {
            const latestReport = JSON.parse(
              fs.readFileSync(path.join(reportsDir, reportFiles[0]), 'utf8')
            );
            
            const implementationRate = latestReport.implementation_rate;
            const totalMethods = latestReport.total_methods;
            const implementedMethods = latestReport.implemented_methods;
            const missingMethods = latestReport.missing_methods;
            
            let status = '✅';
            if (implementationRate < 0.8) {
              status = '⚠️';
            }
            if (implementationRate < 0.5) {
              status = '❌';
            }
            
            const comment = `## Method Implementation Check Results
            
${status} **Implementation Rate**: ${(implementationRate * 100).toFixed(1)}%
📊 **Statistics**:
- Total Methods: ${totalMethods}
- Implemented: ${implementedMethods}
- Missing: ${missingMethods}

${latestReport.recommendations.map(rec => `- ${rec}`).join('\n')}

<details>
<summary>Detailed Report</summary>

\`\`\`json
${JSON.stringify(latestReport, null, 2)}
\`\`\`
</details>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } 